var __awaiter=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(l,s){function o(t){try{m(i.next(t))}catch(t){s(t)}}function a(t){try{m(i.throw(t))}catch(t){s(t)}}function m(t){var e;t.done?l(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}m((i=i.apply(t,e||[])).next())}))};const defaultDataPS="$";export class EasyTerminal{constructor(t){var e,n,i,l,s,o;this.config=t,this.nativeCommands=[],this.history=[],this.historyPos=-1,t["data-ps"]||(t["data-ps"]="$"),t.customCommands||(t.customCommands=[]);const a=document.createElement("div");if(a.style.backgroundColor="black",a.style.color="#ddd",a.style.textAlign="left",a.style.height="100%",a.style.display="flex",a.style.flexDirection="column",null===(e=null==t?void 0:t.window)||void 0===e?void 0:e.show){const e=document.createElement("div");e.style.backgroundColor=(null===(n=null==t?void 0:t.window)||void 0===n?void 0:n.bgColor)||"#198754",e.style.color=(null===(i=null==t?void 0:t.window)||void 0===i?void 0:i.textColor)||"white",e.style.padding="7px",e.style.fontWeight="bold",e.innerHTML=(null===(l=null==t?void 0:t.window)||void 0===l?void 0:l.title)||"EasyTerminal",a.appendChild(e)}this.terminalWrapperHtmlElement=document.createElement("div"),this.terminalWrapperHtmlElement.style.padding="15px 15px 0 15px",this.terminalWrapperHtmlElement.style.height="100%",this.terminalWrapperHtmlElement.style.overflow="auto",this.terminalWrapperHtmlElement.style.fontFamily="Courier New,Courier,monospace",this.terminalWrapperHtmlElement.style.fontSize="1rem",(null===(s=null==t?void 0:t.window)||void 0===s?void 0:s.show)&&(this.terminalWrapperHtmlElement.style.borderStyle="solid",this.terminalWrapperHtmlElement.style.borderColor=(null===(o=null==t?void 0:t.window)||void 0===o?void 0:o.bgColor)||"#198754",this.terminalWrapperHtmlElement.style.borderWidth="4px",this.terminalWrapperHtmlElement.style.borderTop="0"),a.appendChild(this.terminalWrapperHtmlElement),this.contentHtmlElement=document.createElement("div"),this.contentHtmlElement.classList.add("content"),this.contentHtmlElement.innerHTML=t.welcome||"";const m=document.createElement("div");m.classList.add("prompt"),this.inputHtmlElement=document.createElement("div"),this.inputHtmlElement.classList.add("input"),this.inputHtmlElement.classList.add("blink"),this.inputHtmlElement.style.outline="none",this.inputHtmlElement.style.width="100%",this.inputHtmlElement.style.wordWrap="break-word",this.inputHtmlElement.style.whiteSpace="pre-wrap",this.inputHtmlElement.style.lineHeight="2em",this.inputHtmlElement.style.color="transparent",this.inputHtmlElement.style.textShadow="0 0 0 #ddd",this.inputHtmlElement.contentEditable="true",this.inputHtmlElement.spellcheck=!1,this.inputHtmlElement.setAttribute("data-ps",t["data-ps"]),m.appendChild(this.inputHtmlElement);let r=!1;this.inputHtmlElement.addEventListener("focusin",(()=>{r=!0})),this.inputHtmlElement.addEventListener("focusout",(()=>{r=!1,this.inputHtmlElement.classList.add("blink")})),setInterval((()=>{r&&!this.inputHtmlElement.textContent&&this.inputHtmlElement.classList.toggle("blink")}),800),this.inputHtmlElement.addEventListener("input",(t=>{var e;(null===(e=null==t?void 0:t.target)||void 0===e?void 0:e.textContent)?(this.inputHtmlElement.classList.add("blink"),this.inputHtmlElement.style.textShadow="none",this.inputHtmlElement.style.color="#ddd"):(this.inputHtmlElement.classList.remove("blink"),this.inputHtmlElement.style.color="transparent",this.inputHtmlElement.style.textShadow="0 0 0 #ddd")})),a.addEventListener("click",(()=>{this.inputHtmlElement.focus()})),this.inputHtmlElement.addEventListener("keydown",(t=>{switch(t.key){case"Enter":t.preventDefault(),this.exec(this.inputHtmlElement.textContent);break;case"ArrowDown":if(t.preventDefault(),!this.config.history)return;this.history[this.historyPos-1]?(this.historyPos--,this.inputHtmlElement.textContent=this.history[this.historyPos].info.fullText):0===this.historyPos&&(this.historyPos=-1,this.inputHtmlElement.textContent="");break;case"ArrowUp":if(t.preventDefault(),!this.config.history)return;this.history[this.historyPos+1]&&(this.historyPos++,this.inputHtmlElement.textContent=this.history[this.historyPos].info.fullText)}}));const d=document.createElement("style");let p=".prompt .input::before { vertical-align: middle; content: attr(data-ps); padding-right: 10px; }";p+='.prompt .input::after { visibility : visible; content: "|"; margin-left:-0.15em;}',p+=".prompt .input.blink::after { visibility : hidden; }",p+=".content ul.select li.selected { list-style : circle !important; }";const h=document.head||document.getElementsByTagName("head")[0];this.headerChildCSS=h.appendChild(d),d.setAttribute("type","text/css"),d.appendChild(document.createTextNode('.prompt .input::before { vertical-align: middle; content: attr(data-ps); padding-right: 10px; }.prompt .input::after { visibility : visible; content: "|"; margin-left:-0.15em;}.prompt .input.blink::after { visibility : hidden; }.content ul.select li.selected { list-style : circle !important; }')),this.terminalWrapperHtmlElement.appendChild(this.contentHtmlElement),this.terminalWrapperHtmlElement.appendChild(m),t.nativeCommands&&this.createNativeCommands(),t.elementHtml.appendChild(a)}getAllCommands(){return[...this.nativeCommands,...this.config.customCommands]}createNativeCommands(){this.nativeCommands=[{name:"clear",help:"Cleans the screen leaving a new command prompt ready.",method:t=>{t.options.terminalElements.content.innerHTML=""}},{name:"help",help:"Displays a list of useful information. Usage: <ul><li><i>help command-name</i> to show <i>command-name</i>'s help.</li><li><i>help -a</i> or <i>help --all</i> to display all help.</li></ul>",method:t=>{var e;if(null===(e=t.options.info.args)||void 0===e?void 0:e.length)if(["--all","-a"].includes(t.options.info.args[0]))t.echoList(this.getAllCommands().map((t=>`<b>${t.name}</b> - ${t.help}`)));else{const e=this.getAllCommands().find((e=>e.name===t.options.info.args[0]));e?t.echo(`<b>${e.name}</b> - ${e.help}`):t.echo(`Command <i>${t.options.info.args[0]}</i> not found.`)}else t.echo('Use "help [comand name]" to display specific info about a command.'),t.echo("Available commands are:"),t.echoList(this.getAllCommands().map((t=>`${t.name}`)),!0)}}]}destroy(){(document.head||document.getElementsByTagName("head")[0]).removeChild(this.headerChildCSS)}exec(t){return __awaiter(this,void 0,void 0,(function*(){const e=document.createElement("div");this.contentHtmlElement.appendChild(e),this.inputHtmlElement.classList.remove("blink"),this.inputHtmlElement.style.color="transparent",this.inputHtmlElement.style.textShadow="0 0 0 #ddd",this.inputHtmlElement.textContent="",this.inputHtmlElement.style.display="none";const n=null==t?void 0:t.split(" ");null==n||n.shift();const i=this.getAllCommands().find((e=>e.name===(null==t?void 0:t.split(" ")[0]))),l=new CMD({terminalElements:{commandContainer:e,content:this.contentHtmlElement,input:this.inputHtmlElement,terminalWrapper:this.terminalWrapperHtmlElement},info:{args:n||[],cmdFound:!!i,fullText:t||"",textArgs:(null==n?void 0:n.join(" "))||"",startDate:new Date}},this.config);if(l.echo(t||"",!0),i)try{yield i.method(l)}catch(e){console.error("Error exec "+t,e)}i||l.echo("Command not found",!1),l.options.info.endDate=new Date,this.config.history&&this.addToHistory(l.options),this.inputHtmlElement.style.display="block",this.inputHtmlElement.focus(),this.terminalWrapperHtmlElement.scrollTop=this.terminalWrapperHtmlElement.scrollHeight}))}addToHistory(t){this.config.history&&(this.history.push(t),this.historyPos=-1)}getHistory(){return this.history}getHTMLElements(){return{content:this.contentHtmlElement,input:this.inputHtmlElement,terminalWrapper:this.terminalWrapperHtmlElement}}}export class CMD{constructor(t,e){this.options=t,this.terminalConfig=e,this.options=t,this.terminalConfig=e}echo(t,e=!1){var n;const i=document.createElement("div");if(i.classList.add("echo"),e&&(i.style.lineHeight="2em"),this.terminalConfig["data-ps"]&&e){const t=document.createElement("span");t.innerHTML=this.terminalConfig["data-ps"],t.style.paddingRight="10px",i.appendChild(t)}const l=document.createElement("span");l.innerHTML=t,i.appendChild(l),null===(n=this.options.terminalElements.commandContainer)||void 0===n||n.appendChild(i)}echoList(t,e=!1){var n;const i=document.createElement("div");i.classList.add("echo"),i.style.lineHeight="2em";const l=document.createElement("ul");l.style.padding="0",l.style.margin="0",t.forEach((t=>{const n=document.createElement("li");e&&(n.style.display="inline-block"),n.style.padding="10px",n.style.listStyle="none",n.innerHTML+=t,l.appendChild(n)})),i.appendChild(l),null===(n=this.options.terminalElements.commandContainer)||void 0===n||n.appendChild(i)}log(){console.log(this)}select(t,e=!1){return t?new Promise((n=>{var i;let l=0;const s=document.createElement("ul");s.classList.add("select"),s.tabIndex=0,s.style.margin="0",s.style.lineHeight="2em",s.style.outline="none",t.forEach(((t,e)=>{const n=document.createElement("li");n.style.listStyle="none",e===l&&n.classList.add("selected"),n.innerHTML=t.label?t.label:t.toString(),s.appendChild(n)}));const o=()=>{setTimeout((()=>s.focus()),0)};o(),this.options.terminalElements.terminalWrapper.addEventListener("click",o),s.addEventListener("keydown",(i=>{switch(i.key){case"Enter":i.preventDefault(),this.options.terminalElements.terminalWrapper.removeEventListener("click",o),s.remove(),e&&this.echo(t[l].label?t[l].label:t[l].toString()),n(t[l]);break;case"ArrowDown":i.preventDefault(),l<t.length-1&&(s.getElementsByTagName("li")[l].classList.remove("selected"),l++,s.getElementsByTagName("li")[l].classList.add("selected"));break;case"ArrowUp":i.preventDefault(),l>0&&(s.getElementsByTagName("li")[l].classList.remove("selected"),l--,s.getElementsByTagName("li")[l].classList.add("selected"))}})),null===(i=this.options.terminalElements.commandContainer)||void 0===i||i.appendChild(s)})):Promise.reject()}}